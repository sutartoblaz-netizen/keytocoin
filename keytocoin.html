<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>KeytoCoin Wallet</title>
<style>
html, body{
  width:100%;
  height:100%;
  margin:0;
  padding:0;
}

body{
  background:
    linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)),
    url("keytocoin.logo") no-repeat center center fixed;
  background-size: cover;
  color:#0f0;
  font-family:monospace;
  padding:20px;
  overflow-x:hidden;
  min-width:100vw;
  min-height:100vh;
  box-sizing:border-box;
}

*, *::before, *::after{
  box-sizing:border-box;
}

button,input{
  padding:6px 10px;
  background:#223;
  color:#0f1;
  border:2px solid #0f1;
  border-radius:6px;
  margin:2px;
}

input{ width:250px; }

#log{
  max-height:200px;
  overflow-y:auto;
  background:#222;
  padding:10px;
  border:1px solid #0f0;
}

/* COIN RAIN */
.coin{
  position:fixed;
  top:-60px;
  width:50px;
  height:50px;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%,#ffd700,#c99700);
  box-shadow:0 0 10px #ff0,inset 0 0 10px #c90;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:#111;
  font-size:14px;
  animation:fall linear forwards;
  z-index:-1;
}

@keyframes fall{
  to{ transform:translateY(110vh) rotate(360deg); opacity:0.85; }
}

/* BRICK TEXT */
.brick-text{
  font-size:30px;
  font-weight:bold;
  display:inline-block;
  background:linear-gradient(90deg,#ff0000,#ff6600,#ffcc00);
  background-size:200% auto;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:brickmove 3s linear infinite;
}

@keyframes brickmove{
  0%{background-position:0% center;}
  100%{background-position:200% center;}
}
</style>
</head>
<body>
<h2>ü™ô‚õìÔ∏è KEYTOCOIN ‚õìÔ∏èü™ô</h2>
<button id="createWalletBtn">Create Wallet</button>
<button id="importWalletBtn">Import Wallet</button>
<button id="startMiningBtn">Start Mining</button>

<p>Address: <span id="address"></span></p>
<p>
Private Key:
<span id="privkey">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
<button id="togglePriv">Show</button>
</p>
<p>
Public Key:
<span id="pubkey">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
<button id="togglePub">Show</button>
</p>
<p>Balance: <span id="balance">0</span> KTC</p>
<hr>
<h3>Mining</h3>
<p>Mined Blocks: <span id="blocks">0</span></p>
<p>Total Supply: <span id="supply">0</span> (Mined Income) / 17,000,000. (Max Supply) </p>
<hr>
<h3>Send Transaction</h3>
<input id="to" placeholder="Recipient Address">
<input id="amount" type="number" placeholder="Amount">
<button id="sendBtn">Send</button>
<hr>
<h3>Blockchain Log</h3>
<pre id="log"></pre>
<div align="center"><span class="brick-text">‚õì‚õèKEYTOCOIN‚õè‚õì</span></div>
<div align="center"><span class="brick-text">‚õì‚õèBLOCKCHAIN‚õè‚õì</span></div>
<script>
const API = "http://localhost:8883";

/* DOM */
const addressEl = document.getElementById("address");
const privkeyEl = document.getElementById("privkey");
const pubkeyEl  = document.getElementById("pubkey");
const balanceEl = document.getElementById("balance");
const blocksEl = document.getElementById("blocks");
const supplyEl = document.getElementById("supply");
const toInput = document.getElementById("to");
const amountInput = document.getElementById("amount");
const logEl = document.getElementById("log");

/* STATE */
let privKey=null, pubKey=null, address=null;
let showPriv=false, showPub=false, miningInterval=null;

/* LOG */
function log(msg){
  const d=document.createElement("div");
  d.textContent=msg;
  logEl.prepend(d);
}

/* HASH */
async function hash(data){
  const buf=new TextEncoder().encode(data);
  const dig=await crypto.subtle.digest("SHA-256",buf);
  return [...new Uint8Array(dig)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* CREATE WALLET */
async function createWallet(){
  const keyPair = await crypto.subtle.generateKey(
    { name:"ECDSA", namedCurve:"P-256" },
    true,
    ["sign","verify"]
  );
  privKey = await crypto.subtle.exportKey("jwk", keyPair.privateKey);
  pubKey  = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
  address = (await hash(JSON.stringify(pubKey))).slice(0,64);

  localStorage.setItem("KTC_Wallet",JSON.stringify({ privKey, pubKey, address }));
  log("‚úÖ Wallet created (ECDSA)");
  updateDisplay();
}

/* IMPORT WALLET */
async function importWallet(){
  try{
    privKey = JSON.parse(prompt("Paste PRIVATE KEY (JWK):"));
    pubKey  = JSON.parse(prompt("Paste PUBLIC KEY (JWK):"));
    address = (await hash(JSON.stringify(pubKey))).slice(0,64);
    localStorage.setItem("KTC_Wallet",JSON.stringify({ privKey, pubKey, address }));
    log("üì• Wallet imported");
    updateDisplay();
  }catch{ log("‚õî Invalid key format"); }
}

/* SIGN TX */
async function signTransaction(to, amount){
  const priv = await crypto.subtle.importKey(
    "jwk", privKey,
    { name:"ECDSA", namedCurve:"P-256" },
    false, ["sign"]
  );
  const data = new TextEncoder().encode(address + to + amount);
  const sig = await crypto.subtle.sign({ name:"ECDSA", hash:"SHA-256" }, priv, data);
  return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* VERIFY TX */
async function verifyTransaction(from, to, amount, signature, pubKey){
  const pub = await crypto.subtle.importKey(
    "jwk", pubKey,
    { name:"ECDSA", namedCurve:"P-256" },
    false, ["verify"]
  );
  const data = new TextEncoder().encode(from + to + amount);
  const sigBytes = new Uint8Array(signature.match(/.{1,2}/g).map(b=>parseInt(b,16)));
  return crypto.subtle.verify(
    { name:"ECDSA", hash:"SHA-256" },
    pub, sigBytes, data
  );
}

/* SEND */
async function sendTransaction(){
  const to = toInput.value;
  const amount = parseInt(amountInput.value);
  const signature = await signTransaction(to, amount);

  if(!(await verifyTransaction(address,to,amount,signature,pubKey))){
    log("‚õî Signature invalid (client)");
    return;
  }

  const r = await fetch(`${API}/send`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ from:address, to, amount, signature, pubKey })
  });
  const d = await r.json();
  log(d.error ? "‚ö†Ô∏è "+d.error : "üì® "+d.message);
  syncWallet();
}

/* SYNC WALLET */
async function syncWallet(){
  try{
    const i = await (await fetch(`${API}/wallet/${address}`)).json();
    balanceEl.textContent = i.balance;
    blocksEl.textContent = i.blocks;
    supplyEl.textContent = i.supply;
  }catch{}
}

/* DISPLAY */
function updateDisplay(){
  addressEl.textContent = address || "";
  privkeyEl.textContent = showPriv ? JSON.stringify(privKey) : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
  pubkeyEl.textContent  = showPub  ? JSON.stringify(pubKey)  : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
  if(address) syncWallet();
}

/* PROOF OF WORK FUNCTION */
async function proofOfWork(data, difficulty=4){
  let nonce = 0;
  let hashVal = "";
  const target = "0".repeat(difficulty);
  while(true){
    const text = data + nonce;
    hashVal = await hash(text);
    if(hashVal.startsWith(target)) break;
    nonce++;
    if(nonce%1000===0) await new Promise(r=>setTimeout(r,0)); // yield
  }
  return {nonce, hash:hashVal};
}

/* MINING */
async function mineBlock(){
  try{
    log("‚öôÔ∏è Mining new block (PoW)...");
    const powResult = await proofOfWork(address+"|"+Date.now());
    const r = await fetch(`${API}/mine`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ address, nonce: powResult.nonce, powHash: powResult.hash })
    });
    const d = await r.json();
    log(d.error ? "‚õî "+d.error : "‚õèÔ∏è "+d.message);
    syncWallet();
  }catch(e){ log("‚õî Mining error"); }
}

function startMining(){
  if(!miningInterval){
    miningInterval=setInterval(mineBlock,5000);
    log("‚öôÔ∏è Mining started");
  }
}

/* TOGGLE */
togglePriv.onclick=()=>{ showPriv=!showPriv; togglePriv.textContent=showPriv?"Hide":"Show"; updateDisplay(); };
togglePub.onclick =()=>{ showPub =!showPub;  togglePub.textContent =showPub ?"Hide":"Show"; updateDisplay(); };

/* INIT */
window.onload=()=>{
  createWalletBtn.onclick=createWallet;
  importWalletBtn.onclick=importWallet;
  startMiningBtn.onclick=startMining;
  sendBtn.onclick=sendTransaction;
  updateDisplay();
};

/* P2P RECEIVE SYNC */
const ws=new WebSocket("ws://localhost:8883");
ws.onmessage=e=>{
  const m=JSON.parse(e.data);
  if(m.type==="tx" && m.to===address){
    log("üì• Incoming transaction verified");
    syncWallet();
  }
};

/* COIN RAIN */
setInterval(()=>{
  const c=document.createElement("div");
  c.className="coin";
  c.style.left=Math.random()*100+"vw";
  c.style.animationDuration=(3+Math.random()*4)+"s";
  c.textContent="KTC";
  document.body.appendChild(c);
  setTimeout(()=>c.remove(),7000);
},600);
</script>
</body>
</html>
